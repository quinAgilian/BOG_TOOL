# 为什么 Xcode 能运行，但直接打开应用不行？

## 问题原因

你的应用启用了 **App Sandbox** 和需要 **蓝牙权限**，当直接打开应用时，可能会遇到以下问题：

### 1. **代码签名问题** ⭐ 最常见
- **Xcode 编译时**：Xcode 会自动使用你的开发者证书进行代码签名
- **直接打开时**：如果应用没有正确签名，macOS 会阻止运行
- **原因**：macOS 的安全机制要求所有应用都必须签名

### 2. **Gatekeeper 安全机制**
- macOS 的 Gatekeeper 会检查应用的签名和来源
- 未签名或未公证的应用会被阻止运行
- 即使签名了，如果是从网络下载的，也可能被标记为"隔离"

### 3. **权限请求时机**
- 蓝牙权限需要在应用启动时请求
- 如果应用被 Gatekeeper 阻止，权限请求对话框可能不会出现
- 用户需要在"系统设置 > 隐私与安全性"中手动授权

### 4. **App Sandbox 限制**
- 你的应用启用了 App Sandbox（`com.apple.security.app-sandbox`）
- 这限制了应用的访问权限，需要正确的签名才能正常工作

## 解决方案

### 方案 1：在 Xcode 中设置开发团队（推荐）⭐

**重要：即使没有付费开发者账号，也可以使用免费的 Apple ID！**

#### 使用免费的 Apple ID（个人团队）

1. **首次设置 Apple ID**：
   - 打开 Xcode
   - 菜单栏：**Xcode > Settings** (或 **Preferences**)
   - 选择 **Accounts** 标签
   - 点击左下角的 **+** 号
   - 选择 **Apple ID**
   - 输入你的 Apple ID 和密码（任何 Apple ID 都可以，不需要付费账号）
   - 登录成功后，你会看到 "Personal Team" 或你的名字

2. **在项目中设置团队**：
   - 打开 Xcode 项目
   - 选择项目文件（左侧导航栏最顶部）
   - 选择 **BOG_TOOL** target
   - 打开 **Signing & Capabilities** 标签
   - 在 **Team** 下拉菜单中选择你的 **Personal Team**（显示为你的名字）
   - 确保 **Automatically manage signing** 已勾选
   - Xcode 会自动创建必要的证书和配置文件

3. **重新构建应用**：
   - **Product > Clean Build Folder** (Shift + Command + K)
   - **Product > Build** (Command + B)
   - 构建成功后，应用就可以直接打开了！

#### 免费账号的限制

✅ **可以做的**：
- 在自己的 Mac 上运行应用
- 在 Xcode 中调试和测试
- 使用所有功能（包括蓝牙、文件访问等）

⚠️ **限制**：
- 签名有效期 **7 天**，过期后需要重新构建
- 只能在自己的 Mac 上运行，不能分发给别人
- 不能发布到 App Store
- 不能进行公证（Notarization）

#### 如果遇到 "No signing certificate" 错误

1. 确保已登录 Apple ID（Xcode > Settings > Accounts）
2. 在 Signing & Capabilities 中点击 **Try Again**
3. 如果还是不行，点击 **Manage Certificates**，然后点击 **+** 添加证书

### 方案 2：使用脚本修复权限

```bash
# 给脚本添加执行权限
chmod +x fix_app_permissions.sh

# 运行脚本（替换为你的应用路径）
./fix_app_permissions.sh "/path/to/BOG Tool.app"
```

### 方案 3：手动移除隔离属性

如果应用是从网络下载的：

```bash
# 移除隔离属性
xattr -dr com.apple.quarantine "/path/to/BOG Tool.app"
```

### 方案 4：在系统设置中允许应用

1. 打开 **系统设置** > **隐私与安全性**
2. 如果看到应用被阻止的消息，点击 **仍要打开**
3. 在 **蓝牙** 部分，确保应用有权限

### 方案 5：使用命令行运行（调试用）

```bash
# 直接运行可执行文件（会显示错误信息）
/Applications/"BOG Tool.app"/Contents/MacOS/"BOG Tool"

# 或者使用 open 命令
open "/path/to/BOG Tool.app"
```

## 检查应用状态

### 检查代码签名
```bash
codesign -dv --verbose=4 "/path/to/BOG Tool.app"
```

### 验证签名
```bash
codesign --verify --deep --strict "/path/to/BOG Tool.app"
```

### 检查隔离属性
```bash
xattr -l "/path/to/BOG Tool.app"
```

### 检查 Gatekeeper 状态
```bash
spctl --assess --verbose "/path/to/BOG Tool.app"
```

## 最佳实践

### 对于开发阶段：
- ✅ 始终在 Xcode 中运行（Product > Run）
- ✅ 设置开发团队进行自动签名
- ✅ 使用 Xcode 的 Archive 功能创建可分发的版本

### 对于分发：
- ✅ 使用 Xcode 的 Archive > Distribute App 功能
- ✅ 选择 "Developer ID" 进行签名（需要付费开发者账号）
- ✅ 进行公证（Notarization）以便在 macOS 上正常运行

## 常见错误信息

- **"BOG Tool.app 已损坏，无法打开"** → 签名问题或隔离属性
- **"无法打开 BOG Tool.app，因为无法验证开发者"** → Gatekeeper 阻止
- **"BOG Tool.app 需要更新"** → 签名过期或无效
- **应用启动后立即退出** → 权限问题或沙盒限制

## 总结

**为什么 Xcode 能运行？**
- Xcode 使用开发证书自动签名
- Xcode 有特殊的权限绕过机制
- Xcode 会处理权限请求

**为什么直接打开不行？**
- 可能没有正确签名
- Gatekeeper 阻止运行
- 权限请求被阻止
- 隔离属性阻止执行

**最简单的解决方法：**
1. 在 Xcode 中登录你的 Apple ID（免费的就可以！）
2. 在项目的 Signing & Capabilities 中选择你的 Personal Team
3. 重新构建应用

**重要提示：**
- ✅ **不需要付费开发者账号**！免费的 Apple ID 就可以
- ✅ 应用可以在你自己的 Mac 上正常运行
- ⚠️ 签名有效期 7 天，过期后重新构建即可
- ⚠️ 不能分发给其他人（只能自己用）
